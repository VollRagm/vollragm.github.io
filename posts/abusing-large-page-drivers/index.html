<!DOCTYPE html>













<html lang="en"
  
    data-mode="dark"
  
>

  <!--
  The Head
-->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Allow having a localized datetime different from the appearance language -->
  

  

    

    

  

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Abusing LargePageDrivers to copy shellcode into valid kernel modules" />
<meta property="og:locale" content="en" />
<meta name="description" content="Introduction Most people in the game hacking community write their kernel-mode drivers to get around kernel-level anti-cheats such as EasyAntiCheat. However, those anti-cheats have several methods to detect cheat drivers. The most commonly used way to load the cheat driver is manually mapping it with tools like kdmapper. Unfortunately, manually mapping a driver in this way causes the code to be outside of a valid module. Recommended communication methods like IOCTL are rendered unusable because they can be detected with a few lines of code." />
<meta property="og:description" content="Introduction Most people in the game hacking community write their kernel-mode drivers to get around kernel-level anti-cheats such as EasyAntiCheat. However, those anti-cheats have several methods to detect cheat drivers. The most commonly used way to load the cheat driver is manually mapping it with tools like kdmapper. Unfortunately, manually mapping a driver in this way causes the code to be outside of a valid module. Recommended communication methods like IOCTL are rendered unusable because they can be detected with a few lines of code." />
<link rel="canonical" href="https://vollragm.github.io/posts/abusing-large-page-drivers/" />
<meta property="og:url" content="https://vollragm.github.io/posts/abusing-large-page-drivers/" />
<meta property="og:site_name" content="VollRagm" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-04-10T23:26:00+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Abusing LargePageDrivers to copy shellcode into valid kernel modules" />
<meta name="twitter:site" content="@vollragm" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-04-12T15:46:29+02:00","datePublished":"2022-04-10T23:26:00+02:00","description":"Introduction Most people in the game hacking community write their kernel-mode drivers to get around kernel-level anti-cheats such as EasyAntiCheat. However, those anti-cheats have several methods to detect cheat drivers. The most commonly used way to load the cheat driver is manually mapping it with tools like kdmapper. Unfortunately, manually mapping a driver in this way causes the code to be outside of a valid module. Recommended communication methods like IOCTL are rendered unusable because they can be detected with a few lines of code.","headline":"Abusing LargePageDrivers to copy shellcode into valid kernel modules","mainEntityOfPage":{"@type":"WebPage","@id":"https://vollragm.github.io/posts/abusing-large-page-drivers/"},"url":"https://vollragm.github.io/posts/abusing-large-page-drivers/"}</script>
<!-- End Jekyll SEO tag -->


  <title>Abusing LargePageDrivers to copy shellcode into valid kernel modules | VollRagm
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="VollRagm">
<meta name="application-name" content="VollRagm">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  

    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">

  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/style.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>

</head>


  

  <body data-spy="scroll" data-target="#toc" data-topbar-visible="true">

    <!--
  The Side Bar
-->

<div id="sidebar" class="d-flex flex-column align-items-end">
  <div class="profile-wrapper text-center">
    <div id="avatar">
      <a href="/" alt="avatar" class="mx-auto">
        
          
          <img src="
            
              /assets/img/avatar.png
            
          " alt="avatar" onerror="this.style.display='none'">
        
      </a>
    </div>

    <div class="site-title mt-3">
      <a href="/">VollRagm</a>
    </div>
    <div class="site-subtitle font-italic">Moderator @ unknowncheats.me, reverse engineer</div>

  </div><!-- .profile-wrapper -->

  <ul class="w-100">

    <!-- home -->
    <li class="nav-item">
      <a href="/" class="nav-link">
        <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i>
        <span>HOME</span>
      </a>
    </li>
    <!-- the real tabs -->
    
    <li class="nav-item">
      <a href="/categories/" class="nav-link">
        <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>CATEGORIES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/tags/" class="nav-link">
        <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>TAGS</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/archives/" class="nav-link">
        <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>ARCHIVES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/about/" class="nav-link">
        <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>ABOUT</span>
      </a>
    </li> <!-- .nav-item -->
    

  </ul> <!-- ul.nav.flex-column -->

  <div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center">

    

    
      

      
      <a href="https://github.com/vollragm" aria-label="github"
        target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
      

    
      

      
      <a href="https://twitter.com/vollragm" aria-label="twitter"
        target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
      

    
      

      
      <a href="https://www.unknowncheats.me/forum/members/2377277.html" aria-label="unknowncheats"
        target="_blank" rel="noopener">
        <i class="fab uc"></i>
      </a>
      

    
      

      
      <a href="
          javascript:location.href = 'mailto:' + ['vollragm','gmail.com'].join('@')" aria-label="email"
        >
        <i class="fas fa-envelope"></i>
      </a>
      

    

  </div> <!-- .sidebar-bottom -->

</div><!-- #sidebar -->


    <!--
  The Top Bar
-->

<div id="topbar-wrapper" class="row justify-content-center">
  <div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between">
    <span id="breadcrumb">

    

    

      

        
          <span>
            <a href="/">
              Home
            </a>
          </span>

        

      

        

      

        

          
            <span>Abusing LargePageDrivers to copy shellcode into valid kernel modules</span>
          

        

      

    

    </span><!-- endof #breadcrumb -->

    <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i>

    <div id="topbar-title">
      Post
    </div>

    <i id="search-trigger" class="fas fa-search fa-fw"></i>
    <span id="search-wrapper" class="align-items-center">
      <i class="fas fa-search fa-fw"></i>
      <input class="form-control" id="search-input" type="search"
        aria-label="search" autocomplete="off" placeholder="Search...">
    </span>
    <span id="search-cancel" >Cancel</span>
  </div>

</div>


    <div id="main-wrapper">
      <div id="main">

        









<div class="row">

  <!-- core -->
  <div id="core-wrapper" class="col-12 col-lg-11 col-xl-8">
    <div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">

    

    
      
      
        <!--
  Refactor the HTML structure.
-->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Add attribute 'hide-bullet' to the checkbox list -->



<!-- images -->




  
  

  
    
      
      
    

    
    
    

    
    

    
    
    

    
      
      

      
      

      

      
    
      
      

      
      

      

      
    

    
      

      <!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> -->

      

    

    <!-- Add SVG placehoder to prevent layout reflow -->

    

    <!-- Bypass the HTML-proofer test -->
    

    

  
    

    
    
    

    
    

    
    
    

    
      
      

      
      

      

      
    
      
      

      
      

      

      
    

    
      

      <!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> -->

      

    

    <!-- Add SVG placehoder to prevent layout reflow -->

    

    <!-- Bypass the HTML-proofer test -->
    

    

  

  



<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    

    

  

  
  

  

  
  

  

  
  

  




<!-- Wrap prompt element of blockquote with the <div> tag -->







  
  

  

    
      
      

    

    
    

    
    
    

    
      
        
        

    

    
    

    

  

    

    
    

    
    
    

    
      
        
        

    

    
    

    

  

  



<!-- return -->







<h1 data-toc-skip>Abusing LargePageDrivers to copy shellcode into valid kernel modules</h1>

<div class="post-meta text-muted">

  <!-- author -->
  <div>
    
    

    

    By
    <em>
      
        <a href="https://twitter.com/vollragm">VollRagm</a>
      
    </em>
  </div>

  <div class="d-flex">
    <div>
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/timeago.js
-->

<em class="timeago"
    data-ts="1649625960"
    
      data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll"
    
    >
  2022-04-10
</em>

      </span>

      <!-- lastmod date -->
      
      <span>
        Updated
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/timeago.js
-->

<em class="timeago"
    data-ts="1649771189"
    
      data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll"
    
    >
  2022-04-12
</em>

      </span>
      

      <!-- read time -->
      <!--
  Calculate the post's reading time, and display the word count in tooltip
 -->



<!-- words per minute  -->










<!-- return element -->
<span class="readtime" data-toggle="tooltip" data-placement="bottom"
  title="3233 words">
  <em>17 min</em> read</span>


      <!-- page views -->
      
    </div>

  </div> <!-- .d-flex -->

</div> <!-- .post-meta -->

<div class="post-content">
  <h1 id="introduction">Introduction</h1>
<p>Most people in the game hacking community write their kernel-mode drivers to get around kernel-level anti-cheats such as EasyAntiCheat.
However, those anti-cheats have several methods to detect cheat drivers. The most commonly used way to load the cheat driver is manually mapping it with tools like <a href="https://github.com/TheCruZ/kdmapper">kdmapper</a>. Unfortunately, manually mapping a driver in this way causes the code to be outside of a valid module.<br />
Recommended communication methods like <a href="https://docs.microsoft.com/en-us/windows/win32/devio/device-input-and-output-control-ioctl-">IOCTL</a> are rendered unusable because they can be detected with a few lines of code.</p>

<p>While reading through <a href="https://www.microsoftpressstore.com/store/windows-internals-part-1-system-architecture-processes-9780735684188">Windows Internals Part 1</a> and reverse engineering <code class="language-plaintext highlighter-rouge">nt!KiSystemStartup</code> I noticed a possible way to abuse a Windows feature to be able to copy shellcode into valid drivers typically read-only <code class="language-plaintext highlighter-rouge">.data</code> section and most importantly, execute it. This concept can potentially be used to prevent detection from game anti-cheats while communicating with kernel-mode.</p>

<p>Checkout my <a href="https://github.com/VollRagm/lpmapper">lpmapper repository</a> for the finished proof-of-concept.</p>

<p>In this post, I’m going to demonstrate how to make use of this feature to have executable code in kernel-mode without having to allocate any memory.
To understand this concept, we will have to take a short look into one of the core data structures of a processor: Page Tables.</p>

<h1 id="large-pages">Large Pages</h1>
<p>Windows makes use of page tables to be able to create separate virtual memory spaces for each context.
I will not go too much into detail about how they work as there are many posts about page tables out there already, such as <a href="https://back.engineering/23/08/2020/">this one</a>. 
However, one important detail that oftentimes isn’t mentioned is the use of large pages.<br />
A common page table structure looks something like this:</p>

<p><img data-src="https://imgur.com/nEfkFvj.png" alt="" data-proofer-ignore></p>

<p>As you can see in this image, a Page Table (PT) can hold up to 512 Page Table Entries (PTEs). With each page having a size of 4096 bytes, this means the last page table addresses 2 megabytes (512 * 4096) of physical memory. This is where large pages come into play. Large pages are a feature exclusively supported by x64 processors. The 7th bit of PDPT-entries and PD-entries, which is called <code class="language-plaintext highlighter-rouge">PageSize</code> is used to determine, whether this page table entry points to another Page table or an entire physical page with the size the page table would map.</p>

<p>For example, if the <code class="language-plaintext highlighter-rouge">PageSize</code> bit is set on a Page-directory entry (PDE), the page frame number of this entry points to a full contiguous physical 2 megabyte page instead of pointing to another page table. The R/W and NX bits of the PTE decide whether the page is writable or executable. These properties apply to the <strong>entire page</strong>, which means that for normal pages, the smallest protection region you can modify is 4 kilobytes (4096 bytes). For a large page, it is 2 megabytes (512 * 4096 bytes) and for huge pages, it’s 1 gigabyte (512 * 512 * 4096 bytes).</p>

<p>This aspect is going to become important later.</p>

<p>Large pages are used in applications that need to allocate large memory regions and want to be able to access them quicker. Due to the missing step in the virtual to physical translation, the CPU can access large pages faster.</p>

<blockquote class="prompt-tip"><div>
  <p>If you want to inspect the page tables on your system live to get a better understanding of page tables I recommend my tool <a href="https://github.com/VollRagm/PTView">PTView</a>. By default, Windows maps the ntoskrnl.exe and hal.dll images on large pages. You can get their base address from a kernel debugger and enter it into PTView to directly get the large page they are on.</p>
</div></blockquote>

<h1 id="largepagedrivers">LargePageDrivers</h1>
<p>As I mentioned Windows maps the ntoskrnl.exe image onto a large page. However, if we look into <code class="language-plaintext highlighter-rouge">nt!MmLoadSystemImageEx</code> which eventually gets called in the process of Phase 1 system initialization by <code class="language-plaintext highlighter-rouge">nt!IoInitSystem</code>, we will see a function named <code class="language-plaintext highlighter-rouge">MiMapSystemImageWithLargePage</code> being called after a check. As the name says, this function is responsible for mapping system drivers on large pages.
<code class="language-plaintext highlighter-rouge">MiUseLargeDriverPage</code> takes the DriverName string and returns whether the driver should be loaded on a large page.
I have reverse-engineered the function, the LIST_ENTRY struct, and renamed all variables accordingly.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="nc">LARGE_PAGE_DRIVER_LIST_ENTRY</span> 
<span class="p">{</span>
    <span class="n">LIST_ENTRY</span> <span class="n">Flink</span><span class="p">;</span>
    <span class="n">LIST_ENTRY</span> <span class="n">Blink</span><span class="p">;</span>
    <span class="n">UNICODE_STRING</span> <span class="n">Name</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="kr">__stdcall</span> <span class="nf">MiUseLargeDriverPage</span><span class="p">(</span><span class="n">PCUNICODE_STRING</span> <span class="n">DriverName</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">LARGE_PAGE_DRIVER_LIST_ENTRY</span> <span class="o">*</span><span class="n">LargePageDriversListEntry</span><span class="p">;</span> <span class="c1">// rbx</span>

  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">MiFlags</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">MiFlags</span> <span class="o">&amp;</span> <span class="mh">0x10000</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">MapAllDriversIntoLargePages</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span>
  <span class="p">{</span>
      <span class="c1">// Walk the list</span>
    <span class="k">for</span> <span class="p">(</span> <span class="n">LargePageDriversListEntry</span> <span class="o">=</span> <span class="n">LargePageDriversList</span><span class="p">;</span>
          <span class="n">LargePageDriversListEntry</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">LargePageDriversList</span><span class="p">;</span>
          <span class="n">LargePageDriversListEntry</span> <span class="o">=</span> <span class="n">LargePageDriversListEntry</span><span class="o">-&gt;</span><span class="n">Flink</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">RtlEqualUnicodeString</span><span class="p">(</span><span class="n">DriverName</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">LargePageDriversListEntry</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">,</span> <span class="mi">1u</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// return true if MapAllDriversIntoLargePages is true</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>This means, to get a driver to load on a large page during boot we have to make sure it’s in the <code class="language-plaintext highlighter-rouge">LargePageDriversList</code>. By listing all cross-references in IDA we can find out, that this list is being populated inside of <code class="language-plaintext highlighter-rouge">nt!MiInitializeDriverImages</code> which is eventually getting called from <code class="language-plaintext highlighter-rouge">nt!MiInitSystem</code>.<br />
The procedure references the global variable <code class="language-plaintext highlighter-rouge">MmLargePageDriverBuffer</code> from the ntoskrnl <code class="language-plaintext highlighter-rouge">.INIT</code> section. This variable contains the contents of the <code class="language-plaintext highlighter-rouge">HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management\LargePageDrivers</code> value from the registry. This value has to be of type multi-string.<br />
It has to either contain the file names of the drivers separated by null-terminators or a <code class="language-plaintext highlighter-rouge">*</code>, which serves as a wildcard and is going to set the <code class="language-plaintext highlighter-rouge">MapAllDriversIntoLargePages</code> I have defined to true. The decompilation of the function shows how the value is being parsed.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
</pre></td><td class="rouge-code"><pre><span class="n">FirstLargePageDriverEntry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">LargePageDriversList</span><span class="p">;</span>
<span class="n">LargePageDriversList</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">LargePageDriversList</span><span class="p">;</span>

<span class="c1">// Skip this part if there are no entries</span>
<span class="k">if</span> <span class="p">(</span> <span class="n">MmLargePageDriverBufferLength</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span>    
<span class="p">{</span>
<span class="n">StartOfBuffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">MmLargePageDriverBuffer</span><span class="p">;</span>
<span class="n">EndOfBuffer</span> <span class="o">=</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">MmLargePageDriverBuffer</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">((</span><span class="n">MmLargePageDriverBufferLength</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">));</span>
<span class="k">if</span> <span class="p">(</span> <span class="o">&amp;</span><span class="n">MmLargePageDriverBuffer</span> <span class="o">&lt;</span> <span class="n">EndOfBuffer</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="n">whitespaces</span> <span class="o">=</span> <span class="mh">0x100002601</span><span class="n">i64</span><span class="p">;</span>
    <span class="k">do</span>
    <span class="p">{</span>
    <span class="n">currentChar</span> <span class="o">=</span> <span class="o">*</span><span class="n">StartOfBuffer</span><span class="p">;</span>

    <span class="c1">// check if current char is empty</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">currentChar</span> <span class="o">&lt;=</span> <span class="sc">' '</span> 
        <span class="o">&amp;&amp;</span> <span class="n">_bittest64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">whitespaces</span><span class="p">,</span> <span class="n">currentChar</span><span class="p">)</span> 
        <span class="o">||</span> <span class="n">currentChar</span> <span class="o">==</span> <span class="s">"0</span><span class="se">\0</span><span class="s">"</span> <span class="p">)</span>   
    <span class="p">{</span>
        <span class="n">currentChar_1</span> <span class="o">=</span> <span class="n">StartOfBuffer</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">currentChar</span> <span class="o">==</span> <span class="sc">'*'</span> <span class="p">)</span> <span class="c1">// * for wildcard</span>
        <span class="p">{</span>
            <span class="n">MapAllDriversIntoLargePages</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="p">(</span> <span class="n">currentChar_1</span> <span class="o">=</span> <span class="n">StartOfBuffer</span><span class="p">;</span> <span class="n">currentChar_1</span> <span class="o">&lt;</span> <span class="n">EndOfBuffer</span><span class="p">;</span> <span class="o">++</span><span class="n">currentChar_1</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">currentCharValue</span> <span class="o">=</span> <span class="o">*</span><span class="n">currentChar_1</span><span class="p">;</span>  <span class="c1">// skip whitespaces</span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">currentCharValue</span> <span class="o">&lt;=</span> <span class="sc">' '</span> <span class="o">&amp;&amp;</span> <span class="n">_bittest64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">whitespaces</span><span class="p">,</span> <span class="n">currentCharValue</span><span class="p">)</span> <span class="p">)</span>
                <span class="k">break</span><span class="p">;</span>
                
            <span class="k">if</span> <span class="p">(</span> <span class="n">currentCharValue</span> <span class="o">==</span> <span class="s">"0</span><span class="se">\0</span><span class="s">"</span> <span class="p">)</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// allocate some memory for the new entry</span>
        <span class="n">NewLargePageDriverEntry</span> <span class="o">=</span> <span class="n">MiAllocatePool</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span> <span class="sc">' '</span><span class="p">,</span> <span class="mh">0x704C6D4Du</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">NewLargePageDriverEntry</span> <span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="c1">//initialize entry</span>
        <span class="n">DriverNameLength</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">currentChar_1</span> <span class="o">-</span> <span class="n">StartOfBuffer</span><span class="p">);</span>
        <span class="n">NewLargePageDriverEntry</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">.</span><span class="n">Buffer</span> <span class="o">=</span> <span class="n">StartOfBuffer</span><span class="p">;</span>
        <span class="n">NewLargePageDriverEntry</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">.</span><span class="n">Length</span> <span class="o">=</span> <span class="n">DriverNameLength</span><span class="p">;</span>
        <span class="n">NewLargePageDriverEntry</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">.</span><span class="n">MaximumLength</span> <span class="o">=</span> <span class="n">DriverNameLength</span><span class="p">;</span>
        <span class="n">OldEntry</span> <span class="o">=</span> <span class="n">FirstLargePageDriverEntry</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">FirstLargePageDriverEntry</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">LargePageDriversList</span> <span class="p">)</span>
            <span class="n">__fastfail</span><span class="p">(</span><span class="mi">3u</span><span class="p">);</span>

        <span class="c1">// Reassign the list links</span>
        <span class="n">NewLargePageDriverEntry</span><span class="o">-&gt;</span><span class="n">Flink</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">LargePageDriversList</span><span class="p">;</span>
        <span class="o">*&amp;</span><span class="n">NewLargePageDriverEntry</span><span class="o">-&gt;</span><span class="n">Blink</span> <span class="o">=</span> <span class="n">OldEntry</span><span class="p">;</span>
        <span class="n">whitespaces</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x01\0\0</span><span class="s">&amp;</span><span class="se">\x01</span><span class="s">"</span><span class="p">;</span>
        <span class="o">*</span><span class="n">OldEntry</span> <span class="o">=</span> <span class="n">NewLargePageDriverEntry</span><span class="p">;</span>

        <span class="c1">// set new list head</span>
        <span class="n">FirstLargePageDriverEntry</span> <span class="o">=</span> <span class="n">NewLargePageDriverEntry</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">StartOfBuffer</span> <span class="o">=</span> <span class="n">currentChar_1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">while</span> <span class="p">(</span> <span class="n">currentChar_1</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">EndOfBuffer</span> <span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Now we reach the important part. Previously we learned that page protection applies to the entire page. Let’s say we load <code class="language-plaintext highlighter-rouge">beep.sys</code> onto a large page now. Its read-only <code class="language-plaintext highlighter-rouge">.text</code> section only has the size of a single page.<br />
Normally the image loader simply would map the <code class="language-plaintext highlighter-rouge">.text</code> section onto a single page and make it write-protected. The <code class="language-plaintext highlighter-rouge">.data</code> section also gets its own page, which then is going to be writable, but not executable.<br />
However, since the loader now is forced to place both the <code class="language-plaintext highlighter-rouge">.text</code> and <code class="language-plaintext highlighter-rouge">.data</code> sections onto the same page, those sections will be <strong>writable</strong> and <strong>executable</strong>.</p>

<p>Note that this all is achieved without any page table manipulation and is a legitimate Windows feature.<br />
While modifying the normally read-only <code class="language-plaintext highlighter-rouge">.text</code> section still can easily be detected by comparing the image in memory with the file on the disk, we can freely modify the <code class="language-plaintext highlighter-rouge">.data</code> section and write our shellcode into it, which now can be executed.<br />
Finally, since the shellcode remains inside of the driver’s bounds I can directly point the driver’s Device-IO dispatch to the shellcode location inside of the <code class="language-plaintext highlighter-rouge">.data</code> section and call it from user-mode via <code class="language-plaintext highlighter-rouge">DeviceIoControl</code>.</p>

<p>I will demonstrate this using the <code class="language-plaintext highlighter-rouge">beep.sys</code> driver, which is responsible for handling the <a href="https://docs.microsoft.com/en-us/windows/win32/api/utilapiset/nf-utilapiset-beep"><code class="language-plaintext highlighter-rouge">Beep</code></a> API function.</p>

<h1 id="implementation">Implementation</h1>
<blockquote class="prompt-info"><div>
  <p>You can find the full implementation of this in the <a href="https://github.com/VollRagm/lpmapper">lpmapper</a> repository. The lpmapper project will map the shellcode into beep.sys by default. This can be modified to use any other driver easily. If you want to test it, run the lpmapper-test project. Make sure that you added beep.sys to LargePageDrivers in the registry key mentioned above.</p>
</div></blockquote>

<p>Note that this concept can be abused in many different ways. For example, you could also just place the shellcode in a third-party driver and have it jump into your manually mapped driver.</p>

<p>I however wanted to demonstrate a concept that does not require any memory allocation at all. The idea is to write a simple Device-IO dispatch handler, shrink it down to the essential part and only copy its the function’s instruction bytes into the <code class="language-plaintext highlighter-rouge">.data</code> section. Finally, I will assign the beep.sys driver dispatch to that shellcode.</p>

<p>First of all, we have to make sure the <code class="language-plaintext highlighter-rouge">HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management\</code> registry key contains a multi-string value named <code class="language-plaintext highlighter-rouge">LargePageDrivers</code>. We are going to set it to either <code class="language-plaintext highlighter-rouge">beep.sys</code>, or <code class="language-plaintext highlighter-rouge">*</code> if you want to load all drivers onto large pages (which would be kind of wasteful).
If we don’t do that, we are going to receive an <code class="language-plaintext highlighter-rouge">ATTEMPTED_WRITE_TO_READONLY_MEMORY</code> bluescreen, since lpmapper doesn’t check if the section is on a large page and is writable.</p>

<p><img data-src="https://i.imgur.com/go5ZIPo.png" alt="" data-proofer-ignore></p>

<p>I started by writing the dispatch handler in C++ since I have learned that compilers produce much better machine code than humans. The handler itself is very simple and supports 3 operations: reading cr3, getting a process main module base address, and arbitrarily reading/writing to process memory.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre></td><td class="rouge-code"><pre><span class="n">NTSTATUS</span> <span class="nf">DeviceIOControlHandler</span><span class="p">(</span><span class="n">PDEVICE_OBJECT</span> <span class="n">device</span><span class="p">,</span> <span class="n">PIRP</span> <span class="n">irp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PIO_STACK_LOCATION</span> <span class="n">irpStack</span> <span class="o">=</span> <span class="n">IoGetCurrentIrpStackLocation</span><span class="p">(</span><span class="n">irp</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">inputBuffer</span> <span class="o">=</span> <span class="n">irpStack</span><span class="o">-&gt;</span><span class="n">Parameters</span><span class="p">.</span><span class="n">DeviceIoControl</span><span class="p">.</span><span class="n">Type3InputBuffer</span><span class="p">;</span>
    <span class="k">auto</span> <span class="n">outputBuffer</span> <span class="o">=</span> <span class="n">irp</span><span class="o">-&gt;</span><span class="n">UserBuffer</span><span class="p">;</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">irpStack</span><span class="o">-&gt;</span><span class="n">Parameters</span><span class="p">.</span><span class="n">DeviceIoControl</span><span class="p">.</span><span class="n">IoControlCode</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">case</span> <span class="n">IOCTL_RDCR3</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">outputBuffer</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span><span class="o">*</span><span class="p">)</span><span class="n">outputBuffer</span> <span class="o">=</span> <span class="n">__readcr3</span><span class="p">();</span> 
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">IOCTL_COPY</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">inputBuffer</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">memory_copy</span><span class="o">*</span> <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">memory_copy</span><span class="o">*</span><span class="p">)</span><span class="n">inputBuffer</span><span class="p">;</span>
                <span class="n">PEPROCESS</span> <span class="n">process</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">PsLookupProcessByProcessId</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">processId</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">process</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">process</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">PEPROCESS</span> <span class="n">sourceProcess</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">?</span> <span class="n">IoGetCurrentProcess</span><span class="p">()</span> <span class="o">:</span> <span class="n">process</span><span class="p">;</span>
                    <span class="n">PEPROCESS</span> <span class="n">targetProcess</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">?</span> <span class="n">process</span> <span class="o">:</span> <span class="n">IoGetCurrentProcess</span><span class="p">();</span>

                    <span class="kt">size_t</span> <span class="n">dummy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="n">MmCopyVirtualMemory</span><span class="p">(</span><span class="n">sourceProcess</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">,</span> <span class="n">targetProcess</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">KernelMode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">);</span>
                    
                    <span class="n">ObDereferenceObject</span><span class="p">(</span><span class="n">process</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">IOCTL_PROCESS_BASE</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">inputBuffer</span> <span class="o">&amp;&amp;</span> <span class="n">outputBuffer</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">HANDLE</span> <span class="n">processId</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">HANDLE</span><span class="o">*</span><span class="p">)</span><span class="n">inputBuffer</span><span class="p">;</span>
                <span class="n">PEPROCESS</span> <span class="n">process</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">PsLookupProcessByProcessId</span><span class="p">(</span><span class="n">processId</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">process</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">process</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">auto</span> <span class="n">base</span> <span class="o">=</span> <span class="n">PsGetProcessSectionBaseAddress</span><span class="p">(</span><span class="n">process</span><span class="p">);</span>
                    <span class="o">*</span><span class="p">(</span><span class="n">PVOID</span><span class="o">*</span><span class="p">)</span><span class="n">outputBuffer</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
                    <span class="n">ObDereferenceObject</span><span class="p">(</span><span class="n">process</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="nl">default:</span>
            <span class="k">return</span> <span class="n">OriginalDispatch</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">irp</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">irp</span><span class="o">-&gt;</span><span class="n">IoStatus</span><span class="p">.</span><span class="n">Information</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">irp</span><span class="o">-&gt;</span><span class="n">IoStatus</span><span class="p">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
    <span class="n">IofCompleteRequest</span><span class="p">(</span><span class="n">irp</span><span class="p">,</span> <span class="n">IO_NO_INCREMENT</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>I wanted to keep this handler as simple as possible, which is why it doesn’t check for NTSTATUS results for example. This is up to you to implement.</p>

<p>After writing the handler I used my <a href="https://github.com/VollRagm/ShellcodeBakery">ShellcodeBakery</a> tool to get the shellcode from the compiled binary and display it as a C++ array ready to copy into a source file.<br />
However, the code calls a few imports. Usually, those imports are located inside of the IAT of the driver image. I won’t be mapping the entire driver image though, because I can only fit 4096 bytes into the beep.sys <code class="language-plaintext highlighter-rouge">.data</code> section and the driver image would be spread out across a few pages.<br />
This is why I made another tool, that builds a “custom” import address table at the end of the shellcode and relocates all import calls in the shellcode to their appropriate IAT entry.<br />
I did the same for the call to the <code class="language-plaintext highlighter-rouge">OriginalDispatch</code>. You can find that function table in the source code <a href="https://github.com/VollRagm/lpmapper/blob/65e1d672db40e932acaa808f566f8df4bc523d35/lpmapper/lpmapper/shellcode.hpp#L88">here</a>. This table gets populated with the import address during runtime before its copied into kernel-mode.</p>

<p>I used <a href="https://github.com/TheCruZ/kdmapper">kdmapper’s</a> <code class="language-plaintext highlighter-rouge">intel_driver</code> library to access kernel memory because it already had lots of useful functions implemented, such as <code class="language-plaintext highlighter-rouge">GetKernelModuleExport</code>.</p>

<p>At first, lpmapper will try to find the beep.sys module and its DriverObject.
I get the module address from <code class="language-plaintext highlighter-rouge">GetKernelModuleExport</code>, to get the DriverObject I created a new function in kdmapper called <code class="language-plaintext highlighter-rouge">CallNtosExport</code>. This function calls <code class="language-plaintext highlighter-rouge">IoGetDeviceObjectPointer</code> to get the Beep DeviceObject. The DeviceObject holds the DriverObject. This happens <a href="https://github.com/VollRagm/lpmapper/blob/65e1d672db40e932acaa808f566f8df4bc523d35/lpmapper/lpmapper/lpmapper.cpp#L46">here</a>.</p>

<p>After that, I get the original driver dispatch from <code class="language-plaintext highlighter-rouge">DriverObject-&gt;MajorFunction[14]</code>. This address is stored in the previously mentioned function table of the shellcode, along with all other needed imports which I can get using <code class="language-plaintext highlighter-rouge">GetKernelModuleExport</code>. The code responsible for this is located <a href="https://github.com/VollRagm/lpmapper/blob/65e1d672db40e932acaa808f566f8df4bc523d35/lpmapper/lpmapper/lpmapper.cpp#L140">here</a>.</p>

<p>Finally, the shellcode is copied into the beep.sys <code class="language-plaintext highlighter-rouge">.data</code> section <a href="https://github.com/VollRagm/lpmapper/blob/65e1d672db40e932acaa808f566f8df4bc523d35/lpmapper/lpmapper/lpmapper.cpp#L27">here</a>.</p>

<p>In the final step, lpmapper sets the DriverObjects Device-IO dispatch to the shellcode location <a href="https://github.com/VollRagm/lpmapper/blob/65e1d672db40e932acaa808f566f8df4bc523d35/lpmapper/lpmapper/lpmapper.cpp#L95">here</a>.</p>

<h2 id="testing"><span class="mr-2">Testing</span><a href="#testing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2>

<p>After running lpmapper you can now test the concept with the <a href="https://github.com/VollRagm/lpmapper/tree/main/lpmapper/lpmapper-test">lpmapper-test</a> project. This project also displays how to interact with the dispatch handler.</p>

<p>The following code contains a reference to a handle to the Beep driver. You can acquire this handle using CreateFile:</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">HANDLE</span> <span class="n">beepHandle</span> <span class="o">=</span> <span class="n">CreateFile</span><span class="p">(</span><span class="s">L"</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">GLOBALROOT</span><span class="se">\\</span><span class="s">Device</span><span class="se">\\</span><span class="s">Beep"</span><span class="p">,</span> <span class="n">FILE_ANY_ACCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> 
                                    <span class="nb">nullptr</span><span class="p">,</span> <span class="n">OPEN_EXISTING</span><span class="p">,</span> <span class="n">FILE_ATTRIBUTE_NORMAL</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>I’ll briefly go over how the 3 supported operations are implemented.</p>

<h2 id="read-cr3"><span class="mr-2">Read CR3</span><a href="#read-cr3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2>
<p>This operation is tested in <a href="https://github.com/VollRagm/lpmapper/blob/65e1d672db40e932acaa808f566f8df4bc523d35/lpmapper/lpmapper-test/lpmapper-test.cpp#L10"><code class="language-plaintext highlighter-rouge">TestReadCr3</code></a>.<br />
It will return the value of the current CPUs <code class="language-plaintext highlighter-rouge">cr3</code> register, which is the DirectoryTableBase of the current process, into the output buffer.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">const</span> <span class="n">ULONG</span> <span class="n">IOCTL_READCR3</span> <span class="o">=</span> <span class="n">CTL_CODE</span><span class="p">(</span><span class="mh">0x8000</span><span class="p">,</span> <span class="mh">0x802</span><span class="p">,</span> <span class="n">METHOD_NEITHER</span><span class="p">,</span> <span class="n">FILE_ANY_ACCESS</span><span class="p">);</span>
<span class="kt">uint64_t</span> <span class="n">cr3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="kt">bool</span> <span class="n">success</span> <span class="o">=</span> <span class="n">DeviceIoControl</span><span class="p">(</span><span class="n">beepHandle</span><span class="p">,</span> <span class="n">IOCTL_READCR3</span><span class="p">,</span>
    <span class="nb">nullptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
    <span class="o">&amp;</span><span class="n">cr3</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">),</span>
    <span class="nb">nullptr</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="getting-a-processes-main-module-base"><span class="mr-2">Getting a processes main module base</span><a href="#getting-a-processes-main-module-base" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2>
<p>This operation is tested in <a href="https://github.com/VollRagm/lpmapper/blob/65e1d672db40e932acaa808f566f8df4bc523d35/lpmapper/lpmapper-test/lpmapper-test.cpp#L30"><code class="language-plaintext highlighter-rouge">TestProcessBase</code></a>.<br />
After passing in a process id into the input buffer it will return that process’s main module base address in the output buffer.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="k">const</span> <span class="n">ULONG</span> <span class="n">IOCTL_PROCESS_BASE</span> <span class="o">=</span> <span class="n">CTL_CODE</span><span class="p">(</span><span class="mh">0x8000</span><span class="p">,</span> <span class="mh">0x800</span><span class="p">,</span> <span class="n">METHOD_NEITHER</span><span class="p">,</span> <span class="n">FILE_ANY_ACCESS</span><span class="p">);</span>

<span class="kt">uint64_t</span> <span class="n">processBase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">uint64_t</span> <span class="n">processId</span> <span class="o">=</span> <span class="n">GetCurrentProcessId</span><span class="p">();</span>

<span class="kt">bool</span> <span class="n">success</span> <span class="o">=</span> <span class="n">DeviceIoControl</span><span class="p">(</span><span class="n">beepHandle</span><span class="p">,</span> <span class="n">IOCTL_PROCESS_BASE</span><span class="p">,</span>
    <span class="o">&amp;</span><span class="n">processId</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">),</span>
    <span class="o">&amp;</span><span class="n">processBase</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">),</span>
    <span class="nb">nullptr</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="reading-and-writing-process-memory"><span class="mr-2">Reading and writing process memory</span><a href="#reading-and-writing-process-memory" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2>
<p>This operation is tested in <a href="https://github.com/VollRagm/lpmapper/blob/65e1d672db40e932acaa808f566f8df4bc523d35/lpmapper/lpmapper-test/lpmapper-test.cpp#L30"><code class="language-plaintext highlighter-rouge">TestMemoryRead</code></a>.<br />
You have to initialize a <code class="language-plaintext highlighter-rouge">memory_copy</code> struct which has to be passed to the input buffer.
The <code class="language-plaintext highlighter-rouge">processId</code> member of that struct holds the target process. The <code class="language-plaintext highlighter-rouge">write</code> member decides whether the procedure reads from the target process, or writes to it. <code class="language-plaintext highlighter-rouge">sourceAddress</code> and <code class="language-plaintext highlighter-rouge">targetAddress</code> have to be set accordingly. The <code class="language-plaintext highlighter-rouge">size</code> member determines the number of bytes to copy.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="nc">memory_copy</span>
<span class="p">{</span>
    <span class="kt">uint64_t</span> <span class="n">processId</span><span class="p">;</span>
    <span class="n">PVOID</span> <span class="n">sourceAddress</span><span class="p">;</span>
    <span class="n">PVOID</span> <span class="n">targetAddress</span><span class="p">;</span>
    <span class="n">BOOL</span> <span class="n">write</span><span class="p">;</span>
    <span class="n">SIZE_T</span> <span class="n">size</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">const</span> <span class="n">ULONG</span> <span class="n">IOCTL_COPY</span> <span class="o">=</span> <span class="n">CTL_CODE</span><span class="p">(</span><span class="mh">0x8000</span><span class="p">,</span> <span class="mh">0x801</span><span class="p">,</span> <span class="n">METHOD_NEITHER</span><span class="p">,</span> <span class="n">FILE_ANY_ACCESS</span><span class="p">);</span>

<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="c1">// buffer for "MZ" + '\0'</span>

<span class="n">memory_copy</span> <span class="n">data</span> <span class="o">=</span> <span class="p">{};</span>

<span class="n">data</span><span class="p">.</span><span class="n">processId</span> <span class="o">=</span> <span class="n">GetCurrentProcessId</span><span class="p">();</span>
<span class="n">data</span><span class="p">.</span><span class="n">targetAddress</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
<span class="n">data</span><span class="p">.</span><span class="n">sourceAddress</span> <span class="o">=</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)</span><span class="n">baseAddress</span><span class="p">;</span>
<span class="n">data</span><span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="n">data</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">//only read MZ into buffer</span>

<span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// set null terminator after "MZ"</span>

<span class="kt">bool</span> <span class="n">success</span> <span class="o">=</span> <span class="n">DeviceIoControl</span><span class="p">(</span><span class="n">beepHandle</span><span class="p">,</span> <span class="n">IOCTL_COPY</span><span class="p">,</span>
    <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">memory_copy</span><span class="p">),</span>
    <span class="nb">nullptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nb">nullptr</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<h1 id="detection">Detection</h1>
<p>I have tested this on an EasyAntiCheat protected game for a substantial amount of time and did not run into a ban, but that is not enough data, since EasyAntiCheat is known for not always banning a player when it detects something.</p>

<p>Since LargePageDrivers is an in-house Windows feature, the best the anti-cheat can do is to give you a little flag for having a driver mapped in such a way.</p>

<p>I’m going to discuss the possible ways how this could potentially be detected - and what can be done to prevent that from happening.</p>

<p>If you noticed any detection vector that I missed feel free to contact me on Discord or Twitter about it.</p>

<h2 id="dispatch-hooks"><span class="mr-2">Dispatch Hooks</span><a href="#dispatch-hooks" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2>
<p>In my example, I hooked the driver’s dispatch. You might be wondering why I can’t just point that to my driver residing inside of a pool.
This simply is, because most modern anti-cheats simply check if the dispatch function is located within the driver’s bounds.<br />
Such a check could look something like this:</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="n">PDRIVER_OBJECT</span> <span class="n">diskDriver</span> <span class="o">=</span> <span class="c1">//get the DriverObject</span>
 
<span class="n">PVOID</span> <span class="n">driverDispatch</span> <span class="o">=</span> <span class="n">diskDriver</span><span class="o">-&gt;</span><span class="n">MajorFunction</span><span class="p">[</span><span class="n">IRP_MJ_DEVICE_CONTROL</span><span class="p">];</span>
 
<span class="k">if</span><span class="p">(</span><span class="n">driverDispatch</span> <span class="o">&gt;</span> <span class="n">diskDriver</span><span class="p">.</span><span class="n">DriverStart</span> <span class="o">+</span> <span class="n">diskDriver</span><span class="p">.</span><span class="n">DriverSize</span> <span class="o">||</span>
   <span class="n">driverDispatch</span> <span class="o">&lt;</span> <span class="n">diskDriver</span><span class="p">.</span><span class="n">DriverStart</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Take action</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The most common anti-cheats have been doing this for ages.<br />
The <a href="https://github.com/adrianyy/EACReversing/blob/20fea8ae5f783394e13aad1a1b358f787db7fe71/EasyAntiCheat.sys/dispatchhook.c#L1">EAC-Reversing repository</a> showcases how EasyAntiCheat was doing it back in 2019 at least.</p>

<p>For BattlEye I have analyzed the recently released full <a href="https://www.unknowncheats.me/forum/anti-cheat-bypass/489381-bedaisy-sys-devirtualized.html">bedaisy.sys dump</a> posted on unknowncheats.me by anypot.</p>

<p>I have found a few of those checks, this could be a self-integrity check, however, the principle is the same:</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="k">for</span> <span class="p">(</span> <span class="n">majorFunctionIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">majorFunctionIndex</span> <span class="o">&lt;</span> <span class="mh">0x1C</span><span class="p">;</span> <span class="o">++</span><span class="n">majorFunctionIndex</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="n">majorFunction</span> <span class="o">=</span> <span class="n">DriverObject</span><span class="o">-&gt;</span><span class="n">MajorFunction</span><span class="p">[</span><span class="n">majorFunctionIndex</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">majorFunction</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">DriverStart</span> <span class="o">=</span> <span class="n">DriverObject</span><span class="o">-&gt;</span><span class="n">DriverStart</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">majorFunction</span> <span class="o">&lt;</span> <span class="n">DriverStart</span> <span class="o">||</span> <span class="n">majorFunction</span> <span class="o">&gt;=</span> <span class="n">DriverStart</span> <span class="o">+</span> <span class="n">DriverObject</span><span class="o">-&gt;</span><span class="n">DriverSize</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// take action</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>If you take a look at those, you will notice that this PoC passes those checks, since the dispatch still points to an address inside of the driver’s bounds.</p>

<p>A way to detect this project specifically would be to parse the Debug symbols for beep.sys and check, if the dispatch is pointing to the correct dispatch handler.
However, you can easily modify this project to use any third-party driver that does not have symbols available.</p>

<p>Another way to at least flag this, is to check whether the dispatch is pointing into an executable section using the PE header. The problem with that once again is, that it is technically not illegal to have the dispatch pointing into the <code class="language-plaintext highlighter-rouge">.data</code> section. It’s not common, but a reputable anti-cheat should be careful in taking action due to such flags. If you use techniques to obfuscate and encrypt the shellcode it could potentially make it even harder to detect reliably.</p>

<h2 id="stack-walking"><span class="mr-2">Stack walking</span><a href="#stack-walking" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2>
<p>Stack walking is an often-discussed detection method used by anti-cheats. It works by delivering APCs to all threads, getting their contexts, and checking the return addresses on the stack. Those are then used to determine whether the thread has been executing code outside of a valid module.<br />
However, in my example, the thread never leaves the beep.sys or ntoskrnl.exe module. It is running inside of the <code class="language-plaintext highlighter-rouge">.data</code> section however, which could lead to a flag if explicitly checked for.</p>

<h2 id="nmi-callbacks"><span class="mr-2">NMI-Callbacks</span><a href="#nmi-callbacks" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2>
<p>Similar to stack walking, NMI callbacks interrupt your thread midway and check where and what it is currently executing.
This could lead to a potential detection if the anti-cheat finds your thread executing inside of the <code class="language-plaintext highlighter-rouge">.data</code> section.</p>

<h1 id="conclusion">Conclusion</h1>
<p>It has been a pleasure researching this feature. I highly recommend you to read through <a href="https://www.microsoftpressstore.com/store/windows-internals-part-1-system-architecture-processes-9780735684188">Windows Internals Part 1</a> as it is a good book and can spark a few ideas.</p>

<p>If you found a mistake in this post or noticed a critical fact that I missed, please contact me over Discord, Twitter, or any channel you find. I highly appreciate any critical feedback I can get.</p>

<h2 id="sources-and-links"><span class="mr-2">Sources and Links</span><a href="#sources-and-links" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2>

<ul>
  <li><a href="https://www.microsoftpressstore.com/store/windows-internals-part-1-system-architecture-processes-9780735684188">Windows Internals Part 1</a></li>
  <li><a href="https://www.unknowncheats.me/forum/anti-cheat-bypass/489381-bedaisy-sys-devirtualized.html">bedaisy.sys devirtualized</a></li>
  <li><a href="https://github.com/adrianyy/EACReversing/">EAC-Reversing</a></li>
  <li><a href="https://github.com/TheCruZ/kdmapper">kdmapper</a></li>
  <li><a href="https://back.engineering/23/08/2020/">Virtual Memory - Intro to Paging Tables</a></li>
  <li><a href="https://twitter.com/daax_rynd">daax</a></li>
</ul>

</div>

<div class="post-tail-wrapper text-muted">

  <!-- categories -->
  
  <div class="post-meta mb-3">
    <i class="far fa-folder-open fa-fw mr-1"></i>
    
      <a href='/categories/kernel-development/'>Kernel Development</a>
  </div>
  

  <!-- tags -->
  
  <div class="post-tags">
    <i class="fa fa-tags fa-fw mr-1"></i>
      
      <a href="/tags/native/"
          class="post-tag no-text-decoration" >native</a>
      
      <a href="/tags/kernel/"
          class="post-tag no-text-decoration" >kernel</a>
      
      <a href="/tags/windows/"
          class="post-tag no-text-decoration" >windows</a>
      
      <a href="/tags/reversing/"
          class="post-tag no-text-decoration" >reversing</a>
      
  </div>
  

  <div class="post-tail-bottom
    d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
    <div class="license-wrapper">

      

        

        This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.

      
    </div>

    <!--
 Post sharing snippet
-->

<div class="share-wrapper">
  <span class="share-label text-muted mr-1">Share</span>
  <span class="share-icons">
    
    

    
      
        <a href="https://twitter.com/intent/tweet?text=Abusing LargePageDrivers to copy shellcode into valid kernel modules - VollRagm&amp;url=https://vollragm.github.io/posts/abusing-large-page-drivers/" data-toggle="tooltip" data-placement="top"
          title="Twitter" target="_blank" rel="noopener" aria-label="Twitter">
          <i class="fa-fw fab fa-twitter"></i>
        </a>
    
      
        <a href="https://www.facebook.com/sharer/sharer.php?title=Abusing LargePageDrivers to copy shellcode into valid kernel modules - VollRagm&amp;u=https://vollragm.github.io/posts/abusing-large-page-drivers/" data-toggle="tooltip" data-placement="top"
          title="Facebook" target="_blank" rel="noopener" aria-label="Facebook">
          <i class="fa-fw fab fa-facebook-square"></i>
        </a>
    
      
        <a href="https://t.me/share/url?url=https://vollragm.github.io/posts/abusing-large-page-drivers/&amp;text=Abusing LargePageDrivers to copy shellcode into valid kernel modules - VollRagm" data-toggle="tooltip" data-placement="top"
          title="Telegram" target="_blank" rel="noopener" aria-label="Telegram">
          <i class="fa-fw fab fa-telegram"></i>
        </a>
    

    <i id="copy-link" class="fa-fw fas fa-link small"
        data-toggle="tooltip" data-placement="top"
        title="Copy link"
        data-title-succeed="Link copied successfully!">
    </i>

  </span>
</div>


  </div><!-- .post-tail-bottom -->

</div><!-- div.post-tail-wrapper -->


      
    
    

    </div>
  </div> <!-- #core-wrapper -->

  <!-- pannel -->
  <div id="panel-wrapper" class="col-xl-3 pl-2 text-muted">

    <div class="access">
      















  <div id="access-lastmod" class="post">
    <div class="panel-heading">Recently Updated</div>
    <ul class="post-content pl-0 pb-1 ml-1 mt-2">
      
        
        
        
      <li><a href="/posts/abusing-large-page-drivers/">Abusing LargePageDrivers to copy shellcode into valid kernel modules</a></li>
      
        
        
        
      <li><a href="/posts/minesweeper/">Reverse engineering Windows 7 Minesweeper</a></li>
      
        
        
        
      <li><a href="/posts/web-api/">Reverse engineering a Web API</a></li>
      
        
        
        
      <li><a href="/posts/kernel-message-box/">Showing a MessageBox from kernel-mode</a></li>
      
    </ul>
  </div> <!-- #access-lastmod -->



      















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <div id="access-tags">
    <div class="panel-heading">Trending Tags</div>
    <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

    
      
      <a class="post-tag" href="/tags/native/">native</a>
    
      
      <a class="post-tag" href="/tags/reversing/">reversing</a>
    
      
      <a class="post-tag" href="/tags/windows/">windows</a>
    
      
      <a class="post-tag" href="/tags/kernel/">kernel</a>
    
      
      <a class="post-tag" href="/tags/net/">.net</a>
    
      
      <a class="post-tag" href="/tags/game-hacking/">game hacking</a>
    

    </div>
  </div>


    </div>

    
      
      



<!-- BS-toc.js will be loaded at medium priority -->
<script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script>

<div id="toc-wrapper" class="pl-0 pr-4 mb-5">
  <div class="panel-heading pl-3 pt-2 mb-2">Contents</div>
  <nav id="toc" data-toggle="toc"></nav>
</div>


    
  </div>

</div>

<!-- tail -->

<div class="row">
  <div class="col-12 col-lg-11 col-xl-8">
    <div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">
      
        
        <!--
 Recommend the other 3 posts according to the tags and categories of the current post,
 if the number is not enough, use the other latest posts to supplement.
-->

<!-- The total size of related posts  -->


<!-- An random integer that bigger than 0  -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy}  -->








  

  
    
  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  








<!-- Fill with the other newlest posts  -->






  <div id="related-posts" class="mt-5 mb-2 mb-sm-4">
    <h3 class="pt-2 mt-1 mb-4 ml-1"
      data-toc-skip>Further Reading</h3>
    <div class="card-deck mb-4">
    
      
      
      <div class="card">
        <a href="/posts/kernel-message-box/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/timeago.js
-->

<em class="timeago small"
    data-ts="1649162640"
    
    >
  2022-04-05
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Showing a MessageBox from kernel-mode</h3>
            <div class="text-muted small">
              <p>
                





                Introduction
Message boxes provide a simple way to show feedback to the user. In user-mode, a message box can be shown with the MessageBoxW API function. However, this API does not exist in kernel-...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/posts/task-manager/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/timeago.js
-->

<em class="timeago small"
    data-ts="1649025540"
    
    >
  2022-04-04
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Reverse engineering Task Manager</h3>
            <div class="text-muted small">
              <p>
                





                Introduction
Some time ago I spent some time reversing Task Manager for fun and practice.
I will share my findings in this blog post. Note that most of the things in this post might not be interest...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/posts/minesweeper/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/timeago.js
-->

<em class="timeago small"
    data-ts="1649103780"
    
    >
  2022-04-04
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Reverse engineering Windows 7 Minesweeper</h3>
            <div class="text-muted small">
              <p>
                





                Introduction

This blog post is about how to approach reverse engineering using the Windows 7 version of Minesweeper as an example. You can get the Windows 7 Minesweeper from https://win7games.com/...
              </p>
            </div>
          </div>
        </a>
      </div>
    
    </div> <!-- .card-deck -->
  </div> <!-- #related-posts -->


      
        
        <!--
  Navigation buttons at the bottom of the post.
-->

<div class="post-navigation d-flex justify-content-between">
  
  <a href="/posts/kernel-message-box/" class="btn btn-outline-primary"
    prompt="Older">
    <p>Showing a MessageBox from kernel-mode</p>
  </a>
  

  
  <span class="btn btn-outline-primary disabled"
    prompt="Newer">
    <p>-</p>
  </span>
  

</div>

      
        
        <!--  The comments switcher -->


      
    </div>
  </div>
</div> <!-- .row -->



        <!--
  The Footer
-->

<footer class="d-flex w-100 justify-content-center">
  <div class="d-flex justify-content-between align-items-center text-muted">
    <div class="footer-left">
      <p class="mb-0">
        © 2022
        <a href="https://twitter.com/vollragm">VollRagm</a>.
        
        <span data-toggle="tooltip" data-placement="top"
          title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span>
        
      </p>
    </div>

    <div class="footer-right">
      <p class="mb-0">
        

        

        Powered by 
          <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
         with 
          <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a>
         theme.

      </p>
    </div>

  </div> <!-- div.d-flex -->
</footer>


      </div>

      <!--
  The Search results
-->
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-12 col-sm-11 post-content">
    <div id="search-hints">
      















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <div id="access-tags">
    <div class="panel-heading">Trending Tags</div>
    <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

    
      
      <a class="post-tag" href="/tags/native/">native</a>
    
      
      <a class="post-tag" href="/tags/reversing/">reversing</a>
    
      
      <a class="post-tag" href="/tags/windows/">windows</a>
    
      
      <a class="post-tag" href="/tags/kernel/">kernel</a>
    
      
      <a class="post-tag" href="/tags/net/">.net</a>
    
      
      <a class="post-tag" href="/tags/game-hacking/">game hacking</a>
    

    </div>
  </div>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>


    </div> <!-- #main-wrapper -->

    

    <div id="mask"></div>

    <a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button">
      <i class="fas fa-angle-up"></i>
    </a>

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script>

<script>
SimpleJekyllSearch({
  searchInput: document.getElementById('search-input'),
  resultsContainer: document.getElementById('search-results'),
  json: '/assets/js/data/search.json',
  searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0">  <a href="{url}">{title}</a>  <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">    {categories}    {tags}  </div>  <p>{snippet}</p></div>',
  noResultsText: '<p class="mt-5">Oops! No result founds.</p>',
  templateMiddleware: function(prop, value, template) {
    if (prop === 'categories') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
      }
    }

    if (prop === 'tags') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
      }
    }
  }
});
</script>


    <!--
  JS selector for site.
-->

<!-- layout specified -->


  



  <!-- image lazy-loading & popup & clipboard -->
  

  







  
    

    

  



  
    

    

  



  
    

    

  




  <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script>







  

  

  







  
    

    

  



  
    

    

  



  
    

    

  



  
    

    

  




  <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script>








<script defer src="/assets/js/dist/post.min.js"></script>



<!-- commons -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script>




  </body>

</html>

